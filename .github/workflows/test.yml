name: Tests

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  test-linux:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        platform: [debian, alpine, arch, slackware]
    steps:
      - uses: actions/checkout@v4
      - name: Test ${{ matrix.platform }}
        run: make -C tests test-${{ matrix.platform }}

  test-macos:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [macos-14, macos-15]  # Sonoma, Sequoia
        profile: [local, work]
    steps:
      - uses: actions/checkout@v4

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@v14

      - name: Test ${{ matrix.profile }} profile
        run: |
          source lib/install-common.sh
          ARCH=$(detect_arch)
          OS=$(detect_os)
          PLATFORM="${OS#*:}"  # Extract platform from "os:platform"
          FLAKE_CONFIG=$(get_flake_config "${{ matrix.profile }}" "$PLATFORM" "$ARCH")

          echo "Testing: $FLAKE_CONFIG (Profile: ${{ matrix.profile }}, OS: $OS, Arch: $ARCH)"
          nix run nixpkgs#home-manager -- switch --flake .#${FLAKE_CONFIG} --impure

      - name: Verify
        run: |
          source lib/install-common.sh
          verify_installation
